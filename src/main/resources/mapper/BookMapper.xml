<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.book_management.dao.BookMapper">

    <resultMap id="BookMap" type="com.book_management.entity.Book">
        <id property="bookId" column="book_id"/>
        <result property="title" column="title"/>
        <result property="author" column="author"/>
        <result property="isbn" column="isbn"/>
        <result property="categoryId" column="category_id"/>
        <result property="categoryName" column="category_name"/>
        <result property="publisher" column="publisher"/>
        <result property="publicationYear" column="publication_year"/>
        <result property="price" column="price"/>
        <result property="totalCopies" column="total_copies"/>
        <result property="availableCopies" column="available_copies"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <select id="findByCondition" resultMap="BookMap" parameterType="map">
        SELECT b.*, c.category_name
        FROM books b
        LEFT JOIN categories c ON b.category_id = c.category_id
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND (
            b.title LIKE CONCAT('%', #{keyword}, '%')
            OR b.author LIKE CONCAT('%', #{keyword}, '%')
            OR b.publisher LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        <if test="categoryId != null">
            AND b.category_id = #{categoryId}
        </if>
        ORDER BY b.book_id DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <select id="countByCondition" resultType="int" parameterType="map">
        SELECT COUNT(*)
        FROM books b
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND (
            b.title LIKE CONCAT('%', #{keyword}, '%')
            OR b.author LIKE CONCAT('%', #{keyword}, '%')
            OR b.publisher LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>
        <if test="categoryId != null">
            AND b.category_id = #{categoryId}
        </if>
    </select>

</mapper>